#Протокол обмена#

В общем устройство должно иметь два канала связи TCP/IP.В одном канале устройство выступает в качестве сервера.
По второму каналу оно является клиентом.Сами каналы шифруются открытым ключом.

Собственно обмен начинается с того, что устройство устанавливает TCP соединение по записаному у него адресу сервера.
В этом канале устройство выступает сервером. Т.е. всегда ждет запроса от сервера. Этот канал называется **главный**.

Второй канал открывает так-же устройство по порту и адресу заданному сервером. Но по этому каналу стройство сообщает ту информацию которая
является оперативной. Этот канал называется **оперативный**.

Все обмены производятся в текстовом виде в кодировке UTF-8. Признаком конца сообщения является символ `\n`. На вопрос мастера слейв обязан всегда отвечать. 
Запросы и ответы оформлены в виде JSON структур. 

    

##Протокол обмена по главному каналу##

После установления соединения устройство посылает сообщение о себе:
```
	{
		"deviceinfo":{
			"id":id_device,			//Уникальный идентификатор устройства
			"onboard":{				//Сообщение о наличии устройств
				"GPRS":true/false,
				"GSM":true/false,
				"ETH":true/false,
				"USB":true/false,
				......
			},
			"soft":{
				"version":"versionsoftware",		//Версия программного обеспечения устройства
				......
			},
			"kye":"open key string",				//Открытая часть ключа
		}
	}

```

В ответ мастер посылает сообщение о собственной индентификации и задает параметры обмена с устройством.
```json 
	{	
		"status":"approved"/"denied с указанием причины в тектовом виде"
		"id":id_server,			//Уникальный идентификатор сервера системы
		"timeout":секунды 			// время тайм-аута данного канала 
		"channel":{
			"ip":"ip_addr",				// ip адрес и порт где сервер ожидает соединения для оперативного канала 
			"port":port					//
			"timeout":секунды 			// время тайм-аута данного канала 
		},
		"debug"{					//Секция отладчика системы
			"make":true,			// true - значит включить отладку, false в противном случае
			"ip":"ip_addr",			// ip адрес и порт куда необходимо посылать отладочную информацию 
			"port":port				// если включена отладка и устройство ранее не было в отладке то оно должно
									// немедленно перезапуститься с нужными параметрами соединения   
		}
		
	}
```
Если устройство получило отказ то оно должно записать во внутренний лог причину отказа и закрыть соединение.   

В дальнейшем сервер по этому каналу посылает свои запросы в следующем виде
```
	{
		"server":id_server,			//Уникальный идентификатор сервера системы
		"get":"идентификатор запрашиваемого ресурса",
		"set":"идентификатор изменяемого ресурса",
		......

	}
``` 
Ответ устройства на это следующий:
```
	{
			"id":id_device,			//Уникальный идентификатор устройства
				......
	
	}
```
